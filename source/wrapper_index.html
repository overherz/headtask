<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}{% endblock %}{% if block('title') %} - {% endif %} {{ settings.site_name.value }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ app.path('/source/css/','plugins.css',true) }}" type="text/css" />
    <link rel="stylesheet" href="//yastatic.net/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ app.path('/source/admin/fonts/font-awesome/css/','font-awesome.min.css',true) }}">
    <link rel="stylesheet" href="{{ app.path('/source/css/','content.css',true) }}" type="text/css" />
    <link rel="stylesheet" href="{{ app.path('/source/css/ui-lightness/','jquery-ui-1.10.4.custom.min.css',true) }}" />
    <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:400,700&subset=latin,cyrillic'  type='text/css'>
    {% block css %}
    {% endblock %}
</head>

<body>
<div id="wrapper" {% if cookie_data.sidebar == 'toggled' %}class="toggled" {% endif %}>

{% block menu %}
    {% include "/source/menu.html" %}
 {% endblock %}

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid" style="padding: 0">
            <div class="row" style="margin-right: 0;">
                <div class="col-lg-12" style="padding-right: 0;" id="pajax">
                {% block body %}{% endblock %}
                </div>
            </div>
        </div>
    </div>
    <!-- /#page-content-wrapper -->

</div>
<!-- /#wrapper -->



<script src="//yastatic.net/jquery/2.1.1/jquery.min.js"></script>
<script src="//yastatic.net/jquery-ui/1.10.4/jquery-ui.min.js"></script>
<script src="/source/js/jquery.pjax.js"></script>
<script src="{{ app.path('/source/js/','functions.js',true) }}"></script>
<script src="//yastatic.net/bootstrap/3.1.1/js/bootstrap.min.js"></script>

{% if globals.user.id_user %}
    <script src="{{ app.path('/source/js/socket.io/','socket.io.js',true)}}"></script>
    <script src="{{ app.path('/notifications/','client.js',true)}}"></script>
    <script src="{{ app.path('projects','projects.js')}}"></script>
    <script src="{{ app.path('/source/js/sound_manager/','soundmanager2-nodebug-jsmin.js',true) }}"></script>
    <script src="{{ app.path('/source/js/ckeditor/','ckeditor.js',true) }}"></script>
    <script src="{{ app.path('/source/js/fancybox/','jquery.fancybox.pack.js',true) }}"></script>
    <script type="text/javascript" src="{{app.path('projects','files.js')}}"></script>
    <script type="text/javascript" src="{{app.path('projects','tasks.js')}}"></script>
{% endif %}
<script type="text/javascript">
    $(document).ready(function($) {
        //$(document).pjax('.pajax', '#pajax');
        if ($.support.pjax) {
            $.pjax.defaults.timeout = 1500;

            $(document).on('click', '.pajax, .logs_table td:not(".nopajax") a', function(event) {
                var menu_parent;
                if ($(this).hasClass('menu_link'))
                {
                    menu_parent = $(this).parent().parent();
                    if (($("#wrapper").hasClass('toggled') || window_width < 1100) && menu_parent.hasClass('dropdown'))
                    {
                        return false;
                    }
                    else
                    {
                        $(".menu_li,.menu_sub_li").removeClass("active");
                        menu_parent.addClass("active");
                        hide_sudmenu();
                        id_dropdown = false;
                    }
                }

                if ($(this).hasClass('menu_sub_link'))
                {
                    $(".menu_li,.menu_sub_li").removeClass("active");
                    var menu_sub = $(this).parent();
                    menu_parent = $(this).parent().parent().parent();
                    menu_sub.addClass("active");
                    menu_parent.addClass('active');

                    var submenu_parent = $(this).parent().parent();
                    if (submenu_parent.hasClass('clone'))
                    {
                        $("[data-dropdown='"+id_dropdown+"']").addClass('active');
                        hide_sudmenu();
                        id_dropdown = false;
                    }
                }

                var container = $("#pajax");
                var vars_dropdown,vars_sudmenu;
                if (menu_parent) vars_dropdown = menu_parent.data('dropdown');
                if (menu_sub) vars_sudmenu = menu_sub.data('submenu');

                $.pjax.click(event, {container: container,vars:{dropdown:vars_dropdown,submenu:vars_sudmenu}})
            });

            $(document).on('pjax:beforeReplace', function() {
                $("#scripts").find("script").remove();
            });

            $(document).on('pjax:popstate', function(data) {
                $(".menu_li,.menu_sub_li").removeClass("active");
                $(".menu_li[data-dropdown='"+data.state.vars.dropdown+"']").addClass('active');
                $(".menu_sub_li[data-submenu='"+data.state.vars.submenu+"']").addClass('active');
            });

            $(document).on('pjax:error', function(event, xhr, textStatus, errorThrown, options) {
                options.success(xhr.responseText, textStatus, xhr);
                return false;
            });
            $(document).on('pjax:success', function() {
                $('input,select').styler();
                get_statuses();
                init_datepicker();
                init_ckeditor();

                $(".get_script").each(function(){
                    var path = $(this).data('path');
            //       add_script(path);
                    $.getScript(path,false,true);
                });
            })
        }

        $(".get_script").each(function(){
            var path = $(this).data('path');
//            add_script(path);
              $.getScript(path,false,true);
        });

        $('input,select').styler();

        {% if globals.user.id_user %}

        var window_width = get_window_width();

        $(".sidebar-brand a").click(function(e) {
            e.stopPropagation();
        });

        var id_dropdown;
        $(".dropdown").click(function(e){
            window_width = get_window_width();
            if ($("#wrapper").hasClass('toggled') || window_width < 1100)
            {
                e.preventDefault();
                var this_id_dropdown = $(this).data('dropdown');
                hide_sudmenu();

                if (id_dropdown != this_id_dropdown)
                {
                    id_dropdown = this_id_dropdown;
                    var position = $(this).position();
                    var html = $(".dropdown"+id_dropdown).clone().addClass('clone').show();
                    html.find("a,li").show();
                    if ($(this).find('.menu_projects_').length == 0) html.css('paddingTop',position.top);
                    $(this).css('backgroundColor','#333');
                    show_overlay();
                    $("body").append(html);
                }
                else id_dropdown = false;
            }
        });

        $(document).on('click','#overlay',function(){
            hide_sudmenu();
            id_dropdown = false;
        });

        $(".sidebar-brand").click(function(e) {
            window_width = get_window_width();
            if (window_width >= 1100)
            {
                hide_sudmenu();
                id_dropdown = false;

                $("#wrapper").toggleClass("toggled");
                var c_tog = false;
                if ($("#wrapper").hasClass('toggled')) c_tog = 'toggled';
                $.cookie('sidebar', c_tog, { expires: 30, path: '/' });
            }
        });

        soundManager.setup({
            useFlashBlock : false,
            url : '/source/js/sound_manager/',
            debugMode : false,
            consoleOnly : false,
            onready : function() {
                soundManager.createSound({
                    id:'new_message',
                    url:'/source/js/sound_manager/sound.mp3'
                });
                soundManager.createSound({
                    id:'call',
                    url:'/source/js/sound_manager/incoming_call.mp3'
                });
            }
        });
        {% endif %}
    });

    function hide_sudmenu()
    {
        var clones = $(".submenu.clone");
        if (clones.length > 0)
        {
            clones.remove();
            hide_overlay();
            $(".dropdown").css('backgroundColor','');
        }
    }

    {% if globals.user.id_user %}
    window.ms = {
        address: "{{globals.message_server}}",
        uniq_key: "{{globals.user.uniq_key}}",
        name: "{{globals.user.fio}}",
        id: "{{globals.user.id_user}}"
    }
    {% endif %}
</script>
{% block js %}
{% endblock %}
<div id="scripts"></div>
</body>
</html>