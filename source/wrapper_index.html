<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}{% endblock %}{% if block('title') %} - {% endif %} {{ settings.site_name.value }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ app.path('/source/css/','plugins.css',true) }}" type="text/css" />
    <link rel="stylesheet" href="//yastatic.net/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ app.path('/source/admin/fonts/font-awesome/css/','font-awesome.min.css',true) }}">
    <link rel="stylesheet" href="{{ app.path('/source/css/','content.css',true) }}" type="text/css" />
    <link rel="stylesheet" href="{{ app.path('/source/css/ui-lightness/','jquery-ui-1.10.4.custom.min.css',true) }}" />
    <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:400,700&subset=latin,cyrillic'  type='text/css'>
    {% block css %}
    {% endblock %}
</head>

<body>
<div id="wrapper" class="{% if cookie_data.sidebar == 'toggled' %}toggled{% endif %} {% if cookie_data.sidebar2 == 'toggled2' %}toggled2{% endif %}">

{% block menu %}
    {% include "/source/menu.html" %}
 {% endblock %}
    <i class="fa {% if cookie_data.sidebar == 'toggled' %}fa-caret-right{% else %}fa-caret-left{% endif %} left_toggle"></i>
    <i class="fa {% if cookie_data.sidebar2 == 'toggled2' %}fa-caret-left{% else %}fa-caret-right{% endif %} right_toggle"></i>
    <div id="page-content-wrapper">
        <div class="container-fluid" style="padding: 0;">
            <div class="row" style="margin-right: 0;">
                <div class="col-lg-12" style="padding-right: 0;position: relative;" id="pajax">
                {% block body %}{% endblock %}
                </div>
            </div>
        </div>
    </div>
    <div id="sidebar_right">
        {% for l in globals.logs.logs %}
        <div class="logs_table_sidebar" style="clear: both;">
            <div style="width: 22px;text-align: center;display: inline-block;">
                <span class="label log_{{ l.type }}" style="margin-top: 2px;text-overflow: ellipsis;overflow: hidden;">{{ ("type_"~l.type)|lang|first }}</span>
                {% if l.action == 'add' %}<i class="fa fa-plus" style="color:#5cb85c;"></i>
                {% elseif l.action == 'edit' %}<i class="fa fa-pencil" style="color:#5bc0de;"></i>
                {% elseif l.action == 'delete' %}<i class="fa fa-trash-o" style="color:#d9534f;"></i>
                {% endif %}
            </div>
            <div {% if l.type == 'file' %}class="nopajax" {% endif %} style="overflow:hidden;font-size: 12px;padding-left: 5px;display:inline-block;vertical-align:top;width: 263px;">
                    {{l.text|raw}}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<audio id="sound_notification" src="/source/js/sound_manager/sound.mp3" type="audio/mp3"></audio>

<script src="//yastatic.net/jquery/2.1.1/jquery.min.js"></script>
<script src="//yastatic.net/jquery-ui/1.10.4/jquery-ui.min.js"></script>
<script src="/source/js/jquery.pjax.js"></script>
<script src="{{ app.path('/source/js/','functions.js',true) }}"></script>
<script src="//yastatic.net/bootstrap/3.1.1/js/bootstrap.min.js"></script>

{% if globals.user.id_user %}
    <script src="{{ app.path('/source/js/socket.io/','socket.io.js',true)}}"></script>
    <script src="{{ app.path('/notifications/','client.js',true)}}"></script>
    <script src="{{ app.path('projects','projects.js')}}"></script>
    <script src="{{ app.path('/source/js/ckeditor/','ckeditor.js',true) }}"></script>
    <script src="{{ app.path('/source/js/fancybox/','jquery.fancybox.pack.js',true) }}"></script>
    <script type="text/javascript" src="{{app.path('projects','files.js')}}"></script>
    <script type="text/javascript" src="{{app.path('projects','tasks.js')}}"></script>
{% endif %}
<script type="text/javascript">
    $(document).ready(function($) {
        $("#sidebar_right").mCustomScrollbar({
            axis:"y",
            theme:"dark-3",
            scrollInertia: 0,
            autoHideScrollbar: true,
            mouseWheel:{ preventDefault: true },
            autoExpandScrollbar: true,
        });

        $("#sidebar-wrapper").mCustomScrollbar({
            axis:"y",
            theme:"light-3",
            scrollInertia: 0,
            autoHideScrollbar: true,
            mouseWheel:{ preventDefault: true },
            autoExpandScrollbar: true
        });

        //$(document).pjax('.pajax', '#pajax');
        if ($.support.pjax) {
            $.pjax.defaults.timeout = 1500;

            $(document).on('click', '.pajax, .logs_table td:not(".nopajax") a', function(event) {
                var menu_parent;
                if ($(this).hasClass('menu_link'))
                {
                    menu_parent = $(this).parent().parent();
                    if (($("#wrapper").hasClass('toggled') || window_width < 1100) && menu_parent.hasClass('dropdown'))
                    {
                        return false;
                    }
                    else
                    {
                        $(".menu_li,.menu_sub_li").removeClass("active");
                        menu_parent.addClass("active");
                        hide_submenu();
                        id_dropdown = false;
                    }
                }

                if ($(this).hasClass('menu_sub_link'))
                {
                    $(".menu_li,.menu_sub_li").removeClass("active");
                    var menu_sub = $(this).parent();
                    menu_parent = $(this).parent().parent().parent();
                    menu_sub.addClass("active");
                    menu_parent.addClass('active');

                    var submenu_parent = $(this).parent().parent();
                    if (submenu_parent.hasClass('clone'))
                    {
                        $("[data-dropdown='"+id_dropdown+"']").addClass('active');
                        hide_submenu();
                        id_dropdown = false;
                    }
                }

                var container = $("#pajax");
                var vars_dropdown,vars_sudmenu;
                if (menu_parent) vars_dropdown = menu_parent.data('dropdown');
                if (menu_sub) vars_sudmenu = menu_sub.data('submenu');

                $.pjax.click(event, {container: container,vars:{dropdown:vars_dropdown,submenu:vars_sudmenu}})
            });

            $(document).on('pjax:beforeReplace', function() {
                $("#scripts").find("script").remove();
            });

            $(document).on('pjax:popstate', function(data) {
                $(".menu_li,.menu_sub_li").removeClass("active");
                $(".menu_li[data-dropdown='"+data.state.vars.dropdown+"']").addClass('active');
                $(".menu_sub_li[data-submenu='"+data.state.vars.submenu+"']").addClass('active');
            });

            $(document).on('pjax:error', function(event, xhr, textStatus, errorThrown, options) {
                options.success(xhr.responseText, textStatus, xhr);
                return false;
            });

            $(document).on('pjax:end', function() {
                init_affix_crumbs();
                style_input();
                get_statuses();
                init_datepicker();
                init_ckeditor();
                if(jQuery().popover)
                {
                    popover();
                }
            });

            $(document).on('pjax:success', function() {
                $(".get_script").each(function(){
                    var path = $(this).data('path');
            //       add_script(path);
                    $.getScript(path,false,true);
                });
            })
        }

        init_affix_crumbs();

        $(".get_script").each(function(){
            var path = $(this).data('path');
//            add_script(path);
              $.getScript(path,false,true);
        });

        style_input();

        {% if globals.user.id_user %}

        var window_width = get_window_width();

        $(".sidebar-brand a").click(function(e) {
            e.stopPropagation();
        });

        var id_dropdown;
        $(".dropdown").click(function(e){
            window_width = get_window_width();
            if ($("#wrapper").hasClass('toggled') || window_width < 1100)
            {
                e.preventDefault();
                var this_id_dropdown = $(this).data('dropdown');
                hide_submenu();

                if (id_dropdown != this_id_dropdown)
                {
                    id_dropdown = this_id_dropdown;
                    var position = $(this).position();
                    var html = $(".dropdown"+id_dropdown).clone().addClass('clone').show();
                    html.find("a,li").show();
                    if ($(this).find('.menu_projects_').length == 0) html.css('paddingTop',position.top);
                    $(this).css('backgroundColor','#333');
                    show_overlay();
                    $("body").append(html);
                }
                else id_dropdown = false;
            }
        });

        $(document).on('click','#overlay',function(){
            hide_submenu();
            id_dropdown = false;
        });

        $(".left_toggle").click(function(e) {
            window_width = get_window_width();
            if (window_width >= 1100)
            {
                hide_submenu();
                id_dropdown = false;

                $("#wrapper").toggleClass("toggled");
                var c_tog = false;
                if ($("#wrapper").hasClass('toggled')) c_tog = 'toggled';
                $.cookie('sidebar', c_tog, { expires: 30, path: '/' });

                if ($(this).hasClass('fa-caret-right'))
                {
                    $(this).removeClass('fa-caret-right').addClass('fa-caret-left')
                }
                else
                {
                    $(this).removeClass('fa-caret-left').addClass('fa-caret-right')
                }
            }
        });

        $(".right_toggle").click(function(e) {
            window_width = get_window_width();
            if (window_width >= 1100)
            {
                hide_submenu();
                id_dropdown = false;

                $("#wrapper").toggleClass("toggled2");
                var c_tog = false;
                if ($("#wrapper").hasClass('toggled2')) c_tog = 'toggled2';
                $.cookie('sidebar2', c_tog, { expires: 30, path: '/' });

                if ($(this).hasClass('fa-caret-right'))
                {
                    $(this).removeClass('fa-caret-right').addClass('fa-caret-left')
                }
                else
                {
                    $(this).removeClass('fa-caret-left').addClass('fa-caret-right')
                }
            }
        });
        {% endif %}
    });

    function init_affix_crumbs(){
        var crumbs = $("#crumbs");
        $("#pajax").css('paddingTop','');
        $(window).off('scroll');
        if (crumbs.length > 0)
        {
            $(window).scroll(function(){
                affix_crumbs(crumbs);
            });
            affix_crumbs(crumbs);
        }
    }

    var mobile = detectmob();

    function affix_crumbs(crumbs) {
        if (!mobile)
        {
            var height = crumbs.height();
            var scrollTop = $(window).scrollTop();
            if (scrollTop > 0)
            {
                crumbs.addClass('affix');
                $("#pajax").css('paddingTop',height+15);
            }
            else
            {
                crumbs.removeClass('affix');
                $("#pajax").css('paddingTop','');
            }
        }
    }

    function hide_submenu()
    {
        var clones = $(".submenu.clone");
        if (clones.length > 0)
        {
            clones.remove();
            hide_overlay();
            $(".dropdown").css('backgroundColor','');
        }
    }

    {% if globals.user.id_user %}
    window.ms = {
        address: "{{globals.message_server}}",
        uniq_key: "{{globals.user.uniq_key}}",
        name: "{{globals.user.fio}}",
        id: "{{globals.user.id_user}}"
    }
    {% endif %}
</script>
{% block js %}
{% endblock %}
<div id="scripts"></div>
</body>
</html>